(t=>{"function"==typeof define&&define.amd?define("googleMaps",t):t()})(function(){Voxel.Maps.Autocomplete=function(t,e,o={}){this.init(t,e,o)},Voxel.Maps.Autocomplete.prototype.selectFirstResult=function(t){},Voxel.Maps.Bounds=function(t,e){this.southwest=t,this.northeast=e,this.init(t,e)},Voxel.Maps.Bounds.prototype.extend=function(t){},Voxel.Maps.Bounds.prototype.empty=function(){},Voxel.Maps.Bounds.prototype.getSourceObject=function(){},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Geocoder=function(){this.init()},Voxel.Maps.getGeocoder=function(){return Voxel.Maps._geocoder||(Voxel.Maps._geocoder=new Voxel.Maps.Geocoder),Voxel.Maps._geocoder},Voxel.Maps.Geocoder.prototype.geocode=function(t,e,o){},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){},Voxel.Maps.Geocoder.prototype.getUserLocation=function({fetchAddress:e=!0,receivedPosition:o=t=>{},receivedAddress:s=t=>{},positionFail:t=()=>{},addressFail:i=()=>{}}={}){if(!navigator.geolocation)return t();navigator.geolocation.getCurrentPosition(t=>{t=new Voxel.Maps.LatLng(t.coords.latitude,t.coords.longitude);o(t),!1!==e&&Voxel.Maps.getGeocoder().geocode(t.toGeocoderFormat(),t=>t?s(t):(Voxel.alert(Voxel_Config.l10n.positionFail,"error"),i()))},()=>t())},Voxel.Maps.LatLng=function(t,e){this.init(t,e)},Voxel.Maps.LatLng.prototype.getLatitude=function(){},Voxel.Maps.LatLng.prototype.getLongitude=function(){},Voxel.Maps.LatLng.prototype.getSourceObject=function(){},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){},Voxel.Maps.Map=function({el:t,zoom:e=10,center:o=new Voxel.Maps.LatLng(Voxel_Config.maps.default_lat,Voxel_Config.maps.default_lng),minZoom:s=4,maxZoom:i=20,draggable:r=!0}){this.init({el:t,zoom:e,center:o,minZoom:s,maxZoom:i,draggable:r})},Voxel.Maps.Map.prototype.setZoom=function(t){},Voxel.Maps.Map.prototype.getZoom=function(){},Voxel.Maps.Map.prototype.getMinZoom=function(){},Voxel.Maps.Map.prototype.getMaxZoom=function(){},Voxel.Maps.Map.prototype.setCenter=function(t){},Voxel.Maps.Map.prototype.getCenter=function(){},Voxel.Maps.Map.prototype.fitBounds=function(t){},Voxel.Maps.Map.prototype.panTo=function(t){},Voxel.Maps.Map.prototype.getClickPosition=function(t){},Voxel.Maps.Map.prototype.addListener=function(t,e){},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){},Voxel.Maps.Map.prototype.removeListener=function(t){},Voxel.Maps.Map.prototype.trigger=function(t){},Voxel.Maps.Map.prototype.mapEvent=function(t){return void 0!==this.eventMap[t]?this.eventMap[t]:t},Voxel.Maps.Map.prototype.removeMarkers=function(){for(var t=0;t<this.markers.length;t++)this.markers[t].remove();this.markers=[]},Voxel.Maps.Map.prototype.getSourceObject=function(){},Voxel.Maps.Marker=function({map:t=null,position:e=null,onClick:o=null,template:s=null,data:i=null}){this.template=s,this.init({map:t,position:e,onClick:o,data:i})},Voxel.Maps.Marker.prototype.getPosition=function(){},Voxel.Maps.Marker.prototype.setPosition=function(t){},Voxel.Maps.Marker.prototype.getMap=function(){},Voxel.Maps.Marker.prototype.setMap=function(t){},Voxel.Maps.Marker.prototype.remove=function(){},Voxel.Maps.Marker.prototype.addClass=function(){},Voxel.Maps.Marker.prototype.removeClass=function(){},Voxel.Maps.Marker.prototype.getTemplate=function(){var t=this.template||'<div class="map-marker marker-type-icon"><i class="las la-map-marker"></i></div>';return jQuery(`<div class="marker-wrapper">${t}</div>`)},Voxel.Maps.Popup=function({map:t=null,position:e=null,content:o=null}){this.init({map:t,position:e,content:o})},Voxel.Maps.Popup.prototype.init=function(t){},Voxel.Maps.Popup.prototype.setContent=function(t){},Voxel.Maps.Popup.prototype.setPosition=function(t){},Voxel.Maps.Popup.prototype.setMap=function(t){},Voxel.Maps.Popup.prototype.show=function(){},Voxel.Maps.Popup.prototype.hide=function(){},Voxel.Maps.Circle=function({map:t=null,center:e=null,radius:o=null,visible:s=null,className:i="map-circle"}){this.init({map:t,center:e,radius:o,visible:s,className:i})},Voxel.Maps.Clusterer=function({map:t=null}){this.init({map:t})},Voxel.Maps.Autocomplete.prototype.init=async function(t,e,o){var s,i,r;t instanceof Element&&({AutocompleteSuggestion:s,AutocompleteSessionToken:i,Place:r}=await google.maps.importLibrary("places"),this.el=t,this.input=jQuery(t),this.onChange=e,this.options=o||{},this.dropdown=null,this.focusedItem=0,this.hasQueried=!1,this.requestBase={includedPrimaryTypes:Array.isArray(o?.feature_types)?o.feature_types:void 0,includedRegionCodes:Array.isArray(o?.countries)?o.countries:void 0},this.sessionToken=new i,this.attachDropdown(),this.attachAttribution(),t=Voxel.helpers.debounce(this.querySuggestions.bind(this),200),this.input.on("input",t),this.input.on("focusin",this.showDropdown.bind(this)),this.input.on("focusout",this.hideDropdown.bind(this)),this.input.on("keydown click",this.navigateDropdown.bind(this)),this._AutocompleteSuggestion=s,this._AutocompleteSessionToken=i,this.dropdown.on("mousedown",".suggestion",t=>this.selectItem(jQuery(t.currentTarget).index())))},Voxel.Maps.Autocomplete.prototype.querySuggestions=async function(t){t=(t?.target?.value??this.el.value??"").trim();if(this.resetFocus(),this.showDropdown(),this.onChange(),t)try{var e=(await this._AutocompleteSuggestion.fetchAutocompleteSuggestions({input:t,...this.requestBase,sessionToken:this.sessionToken})).suggestions;this.hasQueried=!0,this.removeSuggestions(),(e||[]).slice(0,5).forEach(t=>{var e=t.placePrediction?.text?.toString?.()||"";this.addSuggestion({text:e,placePrediction:t.placePrediction})})}catch(t){console.log("[Places(New) querySuggestions] failed",t)}else this.removeSuggestions()},Voxel.Maps.Autocomplete.prototype.navigateDropdown=function(t){this.hasQueried||this.input.trigger("input"),this.showDropdown(),40===t.keyCode?(this.focusedItem++,this.focusItem()):38===t.keyCode?(this.focusedItem--,this.focusItem()):13===t.keyCode&&(t.preventDefault(),0!==this.focusedItem)&&this.selectItem(this.focusedItem-1)},Voxel.Maps.Autocomplete.prototype.selectItem=async function(t){t=this.dropdown.find(".suggestions-list .suggestion").eq(t).data("place");if(t?.placePrediction){this.input.val(t.text);try{var e=t.placePrediction.toPlace(),o=(t=>{let e=new Set;return(t||[]).forEach(t=>{switch(t){case"formatted_address":e.add("formattedAddress");break;case"geometry":e.add("location"),e.add("viewport");break;default:e.add(String(t))}}),e.size||e.add("formattedAddress"),[...e]})(this.options.fields||["formatted_address","geometry"]),s=(await e.fetchFields({fields:o}),((t,e)=>{let o=t.formattedAddress;return{formatted_address:o=e&&t.formattedAddress!==e?e:o,geometry:{location:t.location||null,viewport:t.viewport||null},place_id:t.id||null}})(e,t.text));this.onChange(Voxel.Maps.getGeocoder().formatFeature(s)),this.sessionToken=new this._AutocompleteSessionToken}catch(t){console.error("[Places(New) selectItem] details failed",t)}this.resetFocus(),this.hideDropdown()}},Voxel.Maps.Autocomplete.prototype.selectFirstResult=async function(t){0===this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(0).length&&(await this.selectItem(0),"function"==typeof t)&&t()},Voxel.Maps.Autocomplete.prototype.attachDropdown=function(){this.dropdown=jQuery('<div class="ts-autocomplete-dropdown" data-provider="google_maps"><div class="suggestions-list"></div></div>'),this.input.addClass("ts-autocomplete-input").attr("autocomplete","off"),jQuery("body").append(this.dropdown)},Voxel.Maps.Autocomplete.prototype.attachAttribution=function(){var t=jQuery("<img>"),e=(t.attr("src",Voxel_Config.google_maps.logo_url),jQuery('<div class="ts-autocomplete-attrib"></div>'));e.append(t),this.dropdown.append(e)},Voxel.Maps.Autocomplete.prototype.removeSuggestions=function(){this.dropdown.find(".suggestions-list").empty()},Voxel.Maps.Autocomplete.prototype.addSuggestion=function(t){var e=jQuery('<div class="suggestion"><span class="suggestion--address"></span></div>');e.find(".suggestion--address").text(t.text),e.data("place",t),this.dropdown.find(".suggestions-list").append(e)},Voxel.Maps.Autocomplete.prototype.showDropdown=function(){var t,e;this.el?.value&&(this.dropdown.addClass("active"),t=this.input.get(0).getBoundingClientRect(),e=this.input.offset(),this.dropdown.css({top:e.top+t.height+"px",left:e.left+"px",width:t.width+"px"}))},Voxel.Maps.Autocomplete.prototype.hideDropdown=function(){this.dropdown.removeClass("active")},Voxel.Maps.Autocomplete.prototype.focusItem=function(){this.dropdown.find(".suggestions-list .suggestion").removeClass("active");var t=this.dropdown.find(".suggestions-list .suggestion");this.focusedItem<0&&(this.focusedItem=t.length),this.focusedItem>t.length&&(this.focusedItem=0),0!==this.focusedItem&&t.eq(this.focusedItem-1).addClass("active")},Voxel.Maps.Autocomplete.prototype.resetFocus=function(){this.focusedItem=0,this.dropdown.find(".suggestions-list .suggestion").removeClass("active")},Voxel.Maps.Bounds.prototype.init=function(t,e){this.southwest=t,this.northeast=e,this.bounds=new google.maps.LatLngBounds(t?.getSourceObject(),e?.getSourceObject())},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Bounds.prototype.extend=function(t){this.bounds.extend(t.getSourceObject())},Voxel.Maps.Bounds.prototype.empty=function(){return this.bounds.isEmpty()},Voxel.Maps.Bounds.prototype.getSourceObject=function(){return this.bounds},Voxel.Maps.Geocoder.prototype.init=function(){this.geocoder=new google.maps.Geocoder},Voxel.Maps.Geocoder.prototype.geocode=function(t,o,s){var i=this,r=!1,e={};if(t instanceof google.maps.LatLng)e.location=t;else{if("string"!=typeof t||!t.length)return s(r);e.address=t}"function"==typeof o&&(s=o,o={});o=jQuery.extend({limit:1},o);this.geocoder.geocode(e,(t,e)=>("OK"===e&&t&&t.length?r=1===o.limit?i.formatFeature(t[0]):t.map(this.formatFeature):console.log("Geocoding failed. ["+e+"]"),s(r)))},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){var e=t?.geometry?.location,o=t?.geometry?.viewport;return e&&o?{address:t.formatted_address,latlng:new Voxel.Maps.LatLng(e.lat(),e.lng()),viewport:new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(o.getSouthWest().lat(),o.getSouthWest().lng()),new Voxel.Maps.LatLng(o.getNorthEast().lat(),o.getNorthEast().lng()))}:null},Voxel.Maps.LatLng.prototype.init=function(t,e){this.latlng=new google.maps.LatLng(t,e)},Voxel.Maps.LatLng.prototype.getLatitude=function(){return this.latlng.lat()},Voxel.Maps.LatLng.prototype.getLongitude=function(){return this.latlng.lng()},Voxel.Maps.LatLng.prototype.getSourceObject=function(){return this.latlng},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){return this.latlng},Voxel.Maps.Map.prototype.init=function({el:t,zoom:e,center:o,minZoom:s,maxZoom:i,draggable:r}){this.eventMap={},this.map=new google.maps.Map(t,{zoom:e,minZoom:2<=s?s:2,maxZoom:i,draggable:r,navigationControl:!0,mapTypeId:Voxel_Config.google_maps?.mapTypeId||"roadmap",mapTypeControl:!!Voxel_Config.google_maps?.mapTypeControl,streetViewControl:!!Voxel_Config.google_maps?.streetViewControl,zoomControl:!0,controlSize:32,gestureHandling:"greedy",styles:Voxel_Config.google_maps?.skin||[{featureType:"all",elementType:"labels.text",stylers:[{color:"#878787"}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f9f5ed"}]},{featureType:"road.highway",elementType:"all",stylers:[{color:"#f5f5f5"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#c9c9c9"}]},{featureType:"water",elementType:"all",stylers:[{color:"#aee0f4"}]}]}),this.setCenter(o),t.classList.add("ts-map-loaded"),t.__vx_map__=this},Voxel.Maps.Map.prototype.setZoom=function(t){this.map.setZoom(t)},Voxel.Maps.Map.prototype.getZoom=function(){return this.map.getZoom()},Voxel.Maps.Map.prototype.getMinZoom=function(){return this.map.minZoom},Voxel.Maps.Map.prototype.getMaxZoom=function(){return this.map.maxZoom},Voxel.Maps.Map.prototype.setCenter=function(t){this.map.setCenter(t.getSourceObject())},Voxel.Maps.Map.prototype.getCenter=function(){return new Voxel.Maps.LatLng(this.map.center.lat(),this.map.center.lng())},Voxel.Maps.Map.prototype.getBounds=function(){var t=this.map.getBounds();return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t?.getSouthWest()),new Voxel.Maps.LatLng(t?.getNorthEast()))},Voxel.Maps.Map.prototype.fitBounds=function(t){this.map.fitBounds(t.getSourceObject(),0)},Voxel.Maps.Map.prototype.panTo=function(t){this.map.panTo(t.getSourceObject())},Voxel.Maps.Map.prototype.getClickPosition=function(t){return new Voxel.Maps.LatLng(t.latLng.lat(),t.latLng.lng())},Voxel.Maps.Map.prototype.addListener=function(t,e){return google.maps.event.addListener(this.map,this.mapEvent(t),t=>e(t))},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){return google.maps.event.addListenerOnce(this.map,this.mapEvent(t),t=>e(t))},Voxel.Maps.Map.prototype.removeListener=function(t){google.maps.event.removeListener(t)},Voxel.Maps.Map.prototype.trigger=function(t){google.maps.event.trigger(this.map,this.mapEvent(t))},Voxel.Maps.Map.prototype.getSourceObject=function(){return this.map},Voxel.Maps.Marker.prototype.init=function({map:t,position:e,onClick:o,data:s}){this.data=s,this.marker=new Voxel.Maps.GoogleMapsOverlay(this),this.onClick=o,t&&this.setMap(t),e&&this.setPosition(e)},Voxel.Maps.Marker.prototype.getPosition=function(){return this.position},Voxel.Maps.Marker.prototype.setPosition=function(t){this.position=t,this.marker.setPosition(t?.getSourceObject())},Voxel.Maps.Marker.prototype.getMap=function(){return this.map},Voxel.Maps.Marker.prototype.setMap=function(t){this.map=t,this.marker.setMap(t.getSourceObject())},Voxel.Maps.Marker.prototype.remove=function(){return this.marker.setMap(null),this.marker.remove(),this},Voxel.Maps.Marker.prototype.getSourceObject=function(){return this.marker},Voxel.Maps.Marker.prototype.addClass=function(t){return this.marker.node?.classList.add(t)},Voxel.Maps.Marker.prototype.removeClass=function(t){return this.marker.node?.classList.remove(t)},Voxel.Maps.SetupMarkerOverlay=()=>{Voxel.Maps.GoogleMapsOverlay=function(t){this.marker=t,this.template=t.getTemplate(),this.latlng=t.getPosition()?.getSourceObject()},Voxel.Maps.GoogleMapsOverlay.prototype=new google.maps.OverlayView,Voxel.Maps.GoogleMapsOverlay.prototype.draw=function(){this.node||(this.node=this.template.get(0),this.node._vx_added_listeners||(this.node._vx_added_listeners=!0,this.node.addEventListener("touchstart",t=>t.stopPropagation()),this.node.addEventListener("click",t=>{t.stopPropagation(),this.marker.onClick&&this.marker.onClick(t,this.marker)})),this.getPanes().overlayImage.appendChild(this.node)),this.setPosition(this.latlng)},Voxel.Maps.GoogleMapsOverlay.prototype.remove=function(){this.node&&this.node.remove(),this.node=null},Voxel.Maps.GoogleMapsOverlay.prototype.getPosition=function(){return this.latlng},Voxel.Maps.GoogleMapsOverlay.prototype.getDraggable=function(){return!1},Voxel.Maps.GoogleMapsOverlay.prototype.getVisible=function(){return!0},Voxel.Maps.GoogleMapsOverlay.prototype.setPosition=function(t){this.latlng=t,this.node&&(this.latlng?(t=this.getProjection().fromLatLngToDivPixel(this.latlng),this.node.style.left=t.x+"px",this.node.style.top=t.y+"px",this.node.style.visibility="visible"):this.node.style.visibility="hidden")}},Voxel.Maps.Popup.prototype.init=function({map:t,position:e,content:o}){this.map=t;t=document.createElement("div");t.classList.add("ts-gmaps-popup-initial"),this.popup=new google.maps.InfoWindow({headerContent:t}),e&&this.setPosition(e),o&&this.setContent(o),google.maps.event.addListener(this.popup,"domready",()=>{this.popup.content.closest(".gm-style-iw-a").classList.add("ts-marker"),this.popup.content?.classList?.contains("empty-popup")&&this.popup.content.closest(".gm-style-iw-a").classList.add("ts-marker-empty")})},Voxel.Maps.Popup.prototype.setContent=function(t){this.popup.setContent(t)},Voxel.Maps.Popup.prototype.setPosition=function(t){this.popup.setPosition(t.getSourceObject())},Voxel.Maps.Popup.prototype.setMap=function(t){this.map=t},Voxel.Maps.Popup.prototype.show=function(){this.popup.open(this.map.getSourceObject())},Voxel.Maps.Popup.prototype.hide=function(){this.popup.close()},Voxel.Maps.Circle.prototype.init=function({map:t=null,center:e=null,radius:o=null,className:s=null}){this.overlay=new Voxel.Maps.CircleOverlay(e.getSourceObject(),o,t.getSourceObject(),s),this.circle=this.overlay.circle},Voxel.Maps.Circle.prototype.hide=function(){this.overlay.div_&&(this.overlay.div_.classList.add("hidden"),this.overlay.center_.classList.add("hidden"))},Voxel.Maps.Circle.prototype.show=function(){this.overlay.div_&&(this.overlay.div_.classList.remove("hidden"),this.overlay.center_.classList.remove("hidden"))},Voxel.Maps.Circle.prototype.setCenter=function(t){this.circle.setCenter(t.getSourceObject())},Voxel.Maps.Circle.prototype.setRadius=function(t){this.circle.setRadius(t)},Voxel.Maps.Circle.prototype.getBounds=function(){var t=this.circle.getBounds();return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.getSouthWest()),new Voxel.Maps.LatLng(t.getNorthEast()))},Voxel.Maps.SetupCircleOverlay=()=>{Voxel.Maps.CircleOverlay=function(t,e,o,s){this.circle=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35,clickable:!1,visible:!1,map:o,center:t,radius:e}),this.map_=o,this.div_=null,this.center_=null,this.className_=s,this.setMap(o)},Voxel.Maps.CircleOverlay.prototype=new google.maps.OverlayView,Voxel.Maps.CircleOverlay.prototype.onAdd=function(){var t=document.createElement("div"),e=(t.style.position="absolute",t.className=this.className_+" hidden",document.createElement("div")),e=(e.className="map-circle-inner",e.style.width="100%",e.style.height="100%",e.style.position="absolute",t.appendChild(e),document.createElement("div")),o=(e.className=this.className_+"-center hidden",e.style.position="absolute",this.div_=t,this.center_=e,this.getPanes());o.overlayLayer.appendChild(t),o.overlayLayer.appendChild(e)},Voxel.Maps.CircleOverlay.prototype.draw=function(){var t=this.getProjection(),e=this.circle.getBounds(),o=t.fromLatLngToDivPixel(e.getSouthWest()),s=t.fromLatLngToDivPixel(e.getNorthEast()),i=this.div_,i=(i.style.left=o.x+"px",i.style.top=s.y+"px",i.style.width=s.x-o.x+"px",i.style.height=o.y-s.y+"px",this.center_),o=t.fromLatLngToDivPixel(e.getCenter());i.style.left=o.x+"px",i.style.top=o.y+"px"},Voxel.Maps.CircleOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null,this.center_.parentNode.removeChild(this.center_),this.center_=null}};(function(t){t.exports=(()=>{let p=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class i{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");var[e,o]=new Uint8Array(t,0,2);if(219!==e)throw new Error("Data does not appear to be in a KDBush format.");e=o>>4;if(1!=e)throw new Error(`Got v${e} data when expected v1.`);var s,e=p[15&o];if(e)return[o]=new Uint16Array(t,2,1),[s]=new Uint32Array(t,4,1),new i(s,o,e,t);throw new Error("Unrecognized array type.")}constructor(t,e=64,o=Float64Array,s){if(isNaN(t)||t<=0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;var i=p.indexOf(this.ArrayType),r=2*t*this.ArrayType.BYTES_PER_ELEMENT,n=t*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-n%8)%8;if(i<0)throw new Error(`Unexpected typed array class: ${o}.`);s&&s instanceof ArrayBuffer?(this.data=s,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+n+a,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+r+n+a),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+n+a,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+i]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){var o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=e,o}finish(){var t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return function t(e,o,s,i,r,n){if(r-i<=s)return;let a=i+r>>1;d(e,o,a,i,r,n);t(e,o,s,i,a-1,1-n);t(e,o,s,1+a,r,1-n)}(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,o,s,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");for(var{ids:r,coords:n,nodeSize:t}=this,a=[0,r.length-1,0],p=[];a.length;){var l=a.pop()||0,u=a.pop()||0,c=a.pop()||0;if(u-c<=t)for(let t=c;t<=u;t++){var h=n[2*t],d=n[2*t+1];e<=h&&h<=s&&o<=d&&d<=i&&p.push(r[t])}else{var m=c+u>>1,g=n[2*m],f=n[2*m+1];e<=g&&g<=s&&o<=f&&f<=i&&p.push(r[m]),(0===l?e<=g:o<=f)&&(a.push(c),a.push(m-1),a.push(1-l)),(0===l?g<=s:f<=i)&&(a.push(1+m),a.push(u),a.push(1-l))}}return p}within(e,o,t){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");for(var{ids:s,coords:i,nodeSize:r}=this,n=[0,s.length-1,0],a=[],p=t*t;n.length;){var l=n.pop()||0,u=n.pop()||0,c=n.pop()||0;if(u-c<=r)for(let t=c;t<=u;t++)g(i[2*t],i[2*t+1],e,o)<=p&&a.push(s[t]);else{var h=c+u>>1,d=i[2*h],m=i[2*h+1];g(d,m,e,o)<=p&&a.push(s[h]),(0===l?e-t<=d:o-t<=m)&&(n.push(c),n.push(h-1),n.push(1-l)),(0===l?d<=e+t:m<=o+t)&&(n.push(1+h),n.push(u),n.push(1-l))}}return a}}function d(o,s,i,r,n,a){for(;r<n;){600<n-r&&(p=n-r+1,l=i-r+1,c=Math.log(p),u=.5*Math.exp(2*c/3),c=.5*Math.sqrt(c*u*(p-u)/p)*(l-p/2<0?-1:1),d(o,s,i,Math.max(r,Math.floor(i-l*u/p+c)),Math.min(n,Math.floor(i+(p-l)*u/p+c)),a));var p,l,u,c,h=s[2*i+a];let t=r,e=n;for(m(o,s,r,i),h<s[2*n+a]&&m(o,s,r,n);t<e;){for(m(o,s,t,e),t++,e--;s[2*t+a]<h;)t++;for(;s[2*e+a]>h;)e--}s[2*r+a]===h?m(o,s,r,e):m(o,s,++e,n),e<=i&&(r=e+1),i<=e&&(n=e-1)}}function m(t,e,o,s){r(t,o,s),r(e,2*o,2*s),r(e,2*o+1,2*s+1)}function r(t,e,o){var s=t[e];t[e]=t[o],t[o]=s}function g(t,e,o,s){t-=o,o=e-s;return t*t+o*o}let e={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:t=>t},u=Math.fround||(e=>t=>(e[0]=+t,e[0]))(new Float32Array(1)),f=3,C=5,n=6;class t{constructor(t){this.options=Object.assign(Object.create(e),t),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){var{log:o,minZoom:s,maxZoom:i}=this.options,t=(o&&console.time("total time"),`prepare ${e.length} points`),r=(o&&console.time(t),this.points=e,[]);for(let t=0;t<e.length;t++){var n,a=e[t];a.geometry&&([a,n]=a.geometry.coordinates,a=u(M(a)),n=u(x(n)),r.push(a,n,1/0,t,-1,1),this.options.reduce)&&r.push(0)}let p=this.trees[i+1]=this._createTree(r);o&&console.timeEnd(t);for(let t=i;t>=s;t--){var l=+Date.now();p=this.trees[t]=this._createTree(this._cluster(p,t)),o&&console.log("z%d: %d clusters in %dms",t,p.numItems,+Date.now()-l)}return o&&console.timeEnd("total time"),this}getClusters(t,e){let o=((t[0]+180)%360+360)%360-180;var s=Math.max(-90,Math.min(90,t[1]));let i=180===t[2]?180:((t[2]+180)%360+360)%360-180;var r=Math.max(-90,Math.min(90,t[3]));if(360<=t[2]-t[0])o=-180,i=180;else if(o>i)return t=this.getClusters([o,s,180,r],e),a=this.getClusters([-180,s,i,r],e),t.concat(a);var n,t=this.trees[this._limitZoom(e)],a=t.range(M(o),x(r),M(i),x(s)),p=t.data,l=[];for(n of a){var u=this.stride*n;l.push(1<p[u+C]?c(p,u,this.clusterProps):this.points[p[u+f]])}return l}getChildren(t){var e=this._getOriginId(t),o=this._getOriginZoom(t),s="No cluster with the specified id.",i=this.trees[o];if(!i)throw new Error(s);var r=i.data;if(e*this.stride>=r.length)throw new Error(s);var n,o=this.options.radius/(this.options.extent*Math.pow(2,o-1)),a=r[e*this.stride],e=r[e*this.stride+1],p=[];for(n of i.within(a,e,o)){var l=n*this.stride;r[4+l]===t&&p.push(1<r[l+C]?c(r,l,this.clusterProps):this.points[r[l+f]])}if(0===p.length)throw new Error(s);return p}getLeaves(t,e,o){var s=[];return this._appendLeaves(s,t,e=e||10,o=o||0,0),s}getTile(t,e,o){var s=this.trees[this._limitZoom(t)],t=Math.pow(2,t),{extent:i,radius:r}=this.options,r=r/i,i=(o-r)/t,n=(o+1+r)/t,a={features:[]};return this._addTileFeatures(s.range((e-r)/t,i,(e+1+r)/t,n),s.data,e,o,t,a),0===e&&this._addTileFeatures(s.range(1-r/t,i,1,n),s.data,t,o,t,a),e===t-1&&this._addTileFeatures(s.range(0,i,r/t,n),s.data,-1,o,t,a),a.features.length?a:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;for(;e<=this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e}_appendLeaves(t,e,o,s,i){var r;for(r of this.getChildren(e)){var n=r.properties;if(n&&n.cluster?i+n.point_count<=s?i+=n.point_count:i=this._appendLeaves(t,n.cluster_id,o,s,i):i<s?i++:t.push(r),t.length===o)break}return i}_createTree(e){var o=new i(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let t=0;t<e.length;t+=this.stride)o.add(e[t],e[t+1]);return o.finish(),o.data=e,o}_addTileFeatures(t,i,r,n,a,p){for(var l of t){var u,l=l*this.stride,c=1<i[l+C];let t,e,o;o=c?(t=y(i,l,this.clusterProps),e=i[l],i[1+l]):(h=this.points[i[l+f]],[h,u]=(t=h.properties,h.geometry.coordinates),e=M(h),x(u));var h={type:1,geometry:[[Math.round(this.options.extent*(e*a-r)),Math.round(this.options.extent*(o*a-n))]],tags:t};let s;void 0!==(s=c||this.options.generateId?i[l+f]:this.points[i[l+f]].id)&&(h.id=s),p.features.push(h)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,n){var{radius:e,extent:o,reduce:a,minPoints:s}=this.options,p=e/(o*Math.pow(2,n)),l=t.data,u=[],c=this.stride;for(let r=0;r<l.length;r+=c)if(!(l[r+2]<=n)){l[r+2]=n;var h,d=l[r],m=l[r+1],g=t.within(l[r],l[r+1],p),f=l[r+C];let i=f;for(h of g){var y=h*c;l[2+y]>n&&(i+=l[y+C])}if(i>f&&i>=s){let t=d*f,e=m*f,o,s=-1;var M,x=((r/c|0)<<5)+(n+1)+this.points.length;for(M of g){var v,V=M*c;l[2+V]<=n||(l[2+V]=n,v=l[V+C],t+=l[V]*v,e+=l[1+V]*v,l[4+V]=x,a&&(o||(o=this._map(l,r,!0),s=this.clusterProps.length,this.clusterProps.push(o)),a(o,this._map(l,V))))}l[r+4]=x,u.push(t/i,e/i,1/0,x,-1,i),a&&u.push(s)}else{for(let t=0;t<c;t++)u.push(l[r+t]);if(1<i)for(var w of g){var _=w*c;if(!(l[2+_]<=n)){l[2+_]=n;for(let t=0;t<c;t++)u.push(l[_+t])}}}}return u}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e,o){var s;return 1<t[e+C]?(s=this.clusterProps[t[e+n]],o?Object.assign({},s):s):(s=this.points[t[e+f]].properties,t=this.options.map(s),o&&t===s?Object.assign({},t):t)}}function c(t,e,o){return{type:"Feature",id:t[e+f],properties:y(t,e,o),geometry:{type:"Point",coordinates:[360*(t[e]-.5),(t=>(t=(180-360*t)*Math.PI/180,360*Math.atan(Math.exp(t))/Math.PI-90))(t[e+1])]}}}function y(t,e,o){var s=t[e+C],i=1e4<=s?Math.round(s/1e3)+"k":1e3<=s?Math.round(s/100)/10+"k":s,r=t[e+n],o=-1===r?{}:Object.assign({},o[r]);return Object.assign(o,{cluster:!0,cluster_id:t[e+f],point_count:s,point_count_abbreviated:i})}function M(t){return t/360+.5}function x(t){t=Math.sin(t*Math.PI/180),t=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return t<0?0:1<t?1:t}return t})()})(t={exports:{}});var e=t.exports,t=(Voxel.Maps.Clusterer.prototype.init=function({map:t}){this.map=t,this.markers=[],this.clusters={},this.cluster=new e({radius:60,maxZoom:30}),this.map.addListener("zoom_changed",()=>this.render())},Voxel.Maps.Clusterer.prototype._getGeoJSON=function(){return this.markers.map(function(t,e){return{type:"Feature",geometry:{type:"Point",coordinates:[t.getPosition().getLongitude(),t.getPosition().getLatitude()]},properties:{sID:e+1,scID:0,marker:t}}})},Voxel.Maps.Clusterer.prototype.getSourceObject=function(){return this.cluster},Voxel.Maps.Clusterer.prototype.clearMarkers=function(){this.markers.map(t=>t.remove()),this.markers=[]},Voxel.Maps.Clusterer.prototype.addMarkers=function(t){this.markers.push(...t)},Voxel.Maps.Clusterer.prototype.render=function(){var t=this._getGeoJSON();t.length?(this.cluster.load(t),this.markers.map(t=>t.remove()),t=this.cluster.getClusters([-180,-90,180,90],Math.floor(this.map.getSourceObject().getZoom())),this._removeFeatures(),this._displayFeatures(t)):this._removeFeatures()},Voxel.Maps.Clusterer.prototype._displayFeatures=function(t){t.forEach(o=>{if(o.properties.cluster){var t=`<div class="ts-marker-cluster">${o.properties.point_count_abbreviated}</div>`;let e=new Voxel.Maps.LatLng(o.geometry.coordinates[1],o.geometry.coordinates[0]);t=new Voxel.Maps.Marker({map:this.map,position:e,template:t,onClick:()=>{var t;this.map.getZoom()>=this.map.getMaxZoom()?(t=this.cluster.getLeaves(o.properties.cluster_id,-1).map(t=>t.properties.marker),"function"==typeof this._onNonExpandableClusterClick&&this._onNonExpandableClusterClick(t)):((t=this.map.getSourceObject()).panTo(e.getSourceObject()),t.setZoom(this.cluster.getClusterExpansionZoom(o.properties.cluster_id)),"function"==typeof this._onClusterClick&&this._onClusterClick())}});this.clusters[o.properties.cluster_id]=t.getSourceObject()}else o.properties.marker.setMap(this.map)})},Voxel.Maps.Clusterer.prototype._removeFeatures=function(){Object.values(this.clusters).map(t=>t.setMap(null))},Voxel.Maps.Clusterer.prototype.onClusterClick=function(t){this._onClusterClick=t},Voxel.Maps.Clusterer.prototype.onNonExpandableClusterClick=function(t){this._onNonExpandableClusterClick=t},document.getElementById("google-maps-js"));t&&(t.src=t.dataset.src),Voxel.Maps.GoogleMaps=function(){Voxel.Maps.SetupMarkerOverlay(),Voxel.Maps.SetupCircleOverlay(),Voxel.Maps.Loaded=!0,document.dispatchEvent(new Event("maps:loaded")),jQuery(document).on("voxel:markup-update",()=>{requestAnimationFrame(()=>jQuery(document).trigger("maps:loaded"))})},jQuery(document).on("maps:loaded",()=>{jQuery(".ts-map.ts-map-autoload").each((t,o)=>{if(!o.__map_loaded__){o.__map_loaded__=!0;var s=jQuery(o).data("config"),o={el:o,zoom:3};s&&(s.zoom&&(o.zoom=s.zoom),s.minZoom&&(o.minZoom=s.minZoom),s.maxZoom&&(o.maxZoom=s.maxZoom),s.center)&&(o.center=new Voxel.Maps.LatLng(s.center.lat,s.center.lng));let e=new Voxel.Maps.Map(o);s.markers&&s.markers.forEach(t=>{new Voxel.Maps.Marker({map:e,position:new Voxel.Maps.LatLng(t.lat,t.lng),template:t.uriencoded?decodeURIComponent(t.template):t.template})})}})})});
