(t=>{"function"==typeof define&&define.amd?define("mapbox",t):t()})(function(){Voxel.Maps.Autocomplete=function(t,e,o={}){this.init(t,e,o)},Voxel.Maps.Autocomplete.prototype.selectFirstResult=function(t){},Voxel.Maps.Bounds=function(t,e){this.southwest=t,this.northeast=e,this.init(t,e)},Voxel.Maps.Bounds.prototype.extend=function(t){},Voxel.Maps.Bounds.prototype.empty=function(){},Voxel.Maps.Bounds.prototype.getSourceObject=function(){},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Geocoder=function(){this.init()},Voxel.Maps.getGeocoder=function(){return Voxel.Maps._geocoder||(Voxel.Maps._geocoder=new Voxel.Maps.Geocoder),Voxel.Maps._geocoder},Voxel.Maps.Geocoder.prototype.geocode=function(t,e,o){},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){},Voxel.Maps.Geocoder.prototype.getUserLocation=function({fetchAddress:e=!0,receivedPosition:o=t=>{},receivedAddress:s=t=>{},positionFail:t=()=>{},addressFail:n=()=>{}}={}){if(!navigator.geolocation)return t();navigator.geolocation.getCurrentPosition(t=>{t=new Voxel.Maps.LatLng(t.coords.latitude,t.coords.longitude);o(t),!1!==e&&Voxel.Maps.getGeocoder().geocode(t.toGeocoderFormat(),t=>t?s(t):(Voxel.alert(Voxel_Config.l10n.positionFail,"error"),n()))},()=>t())},Voxel.Maps.LatLng=function(t,e){this.init(t,e)},Voxel.Maps.LatLng.prototype.getLatitude=function(){},Voxel.Maps.LatLng.prototype.getLongitude=function(){},Voxel.Maps.LatLng.prototype.getSourceObject=function(){},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){},Voxel.Maps.Map=function({el:t,zoom:e=10,center:o=new Voxel.Maps.LatLng(Voxel_Config.maps.default_lat,Voxel_Config.maps.default_lng),minZoom:s=4,maxZoom:n=20,draggable:i=!0}){this.init({el:t,zoom:e,center:o,minZoom:s,maxZoom:n,draggable:i})},Voxel.Maps.Map.prototype.setZoom=function(t){},Voxel.Maps.Map.prototype.getZoom=function(){},Voxel.Maps.Map.prototype.getMinZoom=function(){},Voxel.Maps.Map.prototype.getMaxZoom=function(){},Voxel.Maps.Map.prototype.setCenter=function(t){},Voxel.Maps.Map.prototype.getCenter=function(){},Voxel.Maps.Map.prototype.fitBounds=function(t){},Voxel.Maps.Map.prototype.panTo=function(t){},Voxel.Maps.Map.prototype.getClickPosition=function(t){},Voxel.Maps.Map.prototype.addListener=function(t,e){},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){},Voxel.Maps.Map.prototype.removeListener=function(t){},Voxel.Maps.Map.prototype.trigger=function(t){},Voxel.Maps.Map.prototype.mapEvent=function(t){return void 0!==this.eventMap[t]?this.eventMap[t]:t},Voxel.Maps.Map.prototype.removeMarkers=function(){for(var t=0;t<this.markers.length;t++)this.markers[t].remove();this.markers=[]},Voxel.Maps.Map.prototype.getSourceObject=function(){},Voxel.Maps.Marker=function({map:t=null,position:e=null,onClick:o=null,template:s=null,data:n=null}){this.template=s,this.init({map:t,position:e,onClick:o,data:n})},Voxel.Maps.Marker.prototype.getPosition=function(){},Voxel.Maps.Marker.prototype.setPosition=function(t){},Voxel.Maps.Marker.prototype.getMap=function(){},Voxel.Maps.Marker.prototype.setMap=function(t){},Voxel.Maps.Marker.prototype.remove=function(){},Voxel.Maps.Marker.prototype.addClass=function(){},Voxel.Maps.Marker.prototype.removeClass=function(){},Voxel.Maps.Marker.prototype.getTemplate=function(){var t=this.template||'<div class="map-marker marker-type-icon"><i class="las la-map-marker"></i></div>';return jQuery(`<div class="marker-wrapper">${t}</div>`)},Voxel.Maps.Popup=function({map:t=null,position:e=null,content:o=null}){this.init({map:t,position:e,content:o})},Voxel.Maps.Popup.prototype.init=function(t){},Voxel.Maps.Popup.prototype.setContent=function(t){},Voxel.Maps.Popup.prototype.setPosition=function(t){},Voxel.Maps.Popup.prototype.setMap=function(t){},Voxel.Maps.Popup.prototype.show=function(){},Voxel.Maps.Popup.prototype.hide=function(){},Voxel.Maps.Circle=function({map:t=null,center:e=null,radius:o=null,visible:s=null,className:n="map-circle"}){this.init({map:t,center:e,radius:o,visible:s,className:n})},Voxel.Maps.Clusterer=function({map:t=null}){this.init({map:t})},Voxel.Maps.Autocomplete.prototype.init=function(t,e,o){!t instanceof Element||(this.el=t,this.onChange=e,this.input=jQuery(this.el),this.focusedItem=0,this.hasQueried=!1,this.options=o,this.attachDropdown(),this.input.on("input",Voxel.helpers.debounce(this.querySuggestions.bind(this),200)),this.input.on("focusin",this.showDropdown.bind(this)),this.input.on("focusout",this.hideDropdown.bind(this)),this.input.on("keydown click",this.navigateDropdown.bind(this)),this.dropdown.on("mousedown",".suggestion",t=>this.selectItem(jQuery(t.currentTarget).index())))},Voxel.Maps.Autocomplete.prototype.querySuggestions=function(t){this.resetFocus(),this.showDropdown(),this.onChange(),Voxel.Maps.getGeocoder().geocode(t.target.value,{limit:5,_ac:this.options},function(t){if(this.hasQueried=!0,this.removeSuggestions(),!t)return!1;t.forEach(this.addSuggestion.bind(this))}.bind(this))},Voxel.Maps.Autocomplete.prototype.navigateDropdown=function(t){this.hasQueried||this.input.trigger("input"),this.showDropdown(),40===t.keyCode&&(this.focusedItem++,this.focusItem()),38===t.keyCode&&(this.focusedItem--,this.focusItem()),13===t.keyCode&&(t.preventDefault(),0!==this.focusedItem)&&this.selectItem(this.focusedItem-1)},Voxel.Maps.Autocomplete.prototype.focusItem=function(){this.dropdown.find(".suggestions-list .suggestion").removeClass("active");var t=this.dropdown.find(".suggestions-list .suggestion");this.focusedItem<0&&(this.focusedItem=t.length),this.focusedItem>t.length&&(this.focusedItem=0),0!==this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(this.focusedItem-1).addClass("active")},Voxel.Maps.Autocomplete.prototype.resetFocus=function(t){this.focusedItem=0,this.dropdown.find(".suggestions-list .suggestion").removeClass("active")},Voxel.Maps.Autocomplete.prototype.showDropdown=function(t){var e,o;this.el?.value&&(this.dropdown.addClass("active"),e=this.input.get(0).getBoundingClientRect(),o=this.input.offset(),this.dropdown.css({top:o.top+e.height+"px",left:o.left+"px",width:e.width+"px"}))},Voxel.Maps.Autocomplete.prototype.hideDropdown=function(t){this.dropdown.removeClass("active")},Voxel.Maps.Autocomplete.prototype.selectItem=function(t){t=this.dropdown.find(".suggestions-list .suggestion").eq(t).data("place");this.input.val(t.address),this.resetFocus(),this.hideDropdown(),this.onChange(t)},Voxel.Maps.Autocomplete.prototype.selectFirstResult=function(t){0===this.focusedItem&&this.dropdown.find(".suggestions-list .suggestion").eq(0).length&&(this.selectItem(0),t())},Voxel.Maps.Autocomplete.prototype.attachDropdown=function(){this.dropdown=jQuery('<div class="ts-autocomplete-dropdown"><div class="suggestions-list"></div></div>'),this.input.addClass("ts-autocomplete-input").attr("autocomplete","off"),jQuery("body").append(this.dropdown)},Voxel.Maps.Autocomplete.prototype.removeSuggestions=function(){this.dropdown.find(".suggestions-list").html("")},Voxel.Maps.Autocomplete.prototype.addSuggestion=function(t){var e=jQuery(['<div class="suggestion">','<span class="suggestion--address"></span>',"</div>"].join(""));e.data("place",t),e.find(".suggestion--address").text(t.address),this.dropdown.find(".suggestions-list").append(e)},Voxel.Maps.Bounds.prototype.init=function(t,e){this.southwest=t,this.northeast=e,this.bounds=new mapboxgl.LngLatBounds(t?.getSourceObject(),e?.getSourceObject())},Voxel.Maps.Bounds.prototype.getSouthWest=function(){return this.southwest},Voxel.Maps.Bounds.prototype.getNorthEast=function(){return this.northeast},Voxel.Maps.Bounds.prototype.extend=function(t){this.bounds.extend(t.getSourceObject())},Voxel.Maps.Bounds.prototype.empty=function(){return this.bounds.isEmpty()},Voxel.Maps.Bounds.prototype.getSourceObject=function(){return this.bounds},Voxel.Maps.Geocoder.prototype.init=function(){},Voxel.Maps.Geocoder.prototype.geocode=function(t,o,e){var s=this,n=!1;"function"==typeof o&&(e=o,o={});let i=Voxel_Config.mapbox.language;"auto"===i&&(i=null);var r={access_token:Voxel_Config.mapbox?.api_key,limit:1,language:i},a=o._ac,o=(delete o._ac,a?.feature_types?.length&&(o.types=a.feature_types.join(",")),a?.countries?.length&&(o.country=a.countries.join(",")),jQuery.extend(!0,{},r,o));if(!encodeURIComponent(t).length)return e(n);jQuery.get({url:"https://api.mapbox.com/geocoding/v5/mapbox.places/{query}.json".replace("{query}",encodeURIComponent(t)),data:o,dataType:"json",success:function(t,e){"success"===e&&t&&t.features.length&&(n=1===o.limit?s.formatFeature(t.features[0]):t.features.map(s.formatFeature))},complete:function(){e(n)}})},Voxel.Maps.Geocoder.prototype.formatFeature=function(t){var e;return e=t.bbox?new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.bbox[1],t.bbox[0]),new Voxel.Maps.LatLng(t.bbox[3],t.bbox[2])):(e=1/370,new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.geometry.coordinates[1]-e,t.geometry.coordinates[0]-e),new Voxel.Maps.LatLng(t.geometry.coordinates[1]+e,t.geometry.coordinates[0]+e))),{address:t.place_name,latlng:new Voxel.Maps.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]),viewport:e}},Voxel.Maps.LatLng.prototype.init=function(t,e){this.latlng=new mapboxgl.LngLat(e,t)},Voxel.Maps.LatLng.prototype.getLatitude=function(){return this.latlng.lat},Voxel.Maps.LatLng.prototype.getLongitude=function(){return this.latlng.lng},Voxel.Maps.LatLng.prototype.toGeocoderFormat=function(){return[this.getLongitude(),this.getLatitude()].join(",")},Voxel.Maps.LatLng.prototype.getSourceObject=function(){return this.latlng},Voxel.Maps.Map.prototype.init=function({el:t,zoom:e,center:o,minZoom:s,maxZoom:n}){this.eventMap={zoom_changed:"zoomstart",bounds_changed:"moveend"},this.map=new mapboxgl.Map({container:t,zoom:e,minZoom:1.5<=s?s:1.5,maxZoom:n<=24?n:24,interactive:!0,style:Voxel_Config.mapbox?.skin||"mapbox://styles/mapbox/streets-v12",scrollZoom:!0,projection:"mercator",dragRotate:!1,language:Voxel_Config.mapbox.language}),this.map.addControl(new mapboxgl.NavigationControl({showCompass:!1})),this.map.addControl(new mapboxgl.FullscreenControl),this.addListenerOnce("idle",()=>{t?.querySelector?.(".mapbox-improve-map")?.remove?.()}),this.setCenter(o),t.__vx_map__=this},Voxel.Maps.Map.prototype.setZoom=function(t){this.map.setZoom(t)},Voxel.Maps.Map.prototype.getZoom=function(){return this.map.getZoom()},Voxel.Maps.Map.prototype.getMinZoom=function(){return this.map.getMinZoom()},Voxel.Maps.Map.prototype.getMaxZoom=function(){return this.map.getMaxZoom()},Voxel.Maps.Map.prototype.setCenter=function(t){this.map.setCenter(t.getSourceObject())},Voxel.Maps.Map.prototype.getCenter=function(){return new Voxel.Maps.LatLng(this.map.getCenter().lat,this.map.getCenter().lng)},Voxel.Maps.Map.prototype.getBounds=function(){var t=this.map.getBounds(),e=t.getNorthEast(),t=t.getSouthWest();return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(t.lat,t.lng),new Voxel.Maps.LatLng(e.lat,e.lng))},Voxel.Maps.Map.prototype.fitBounds=function(t){t.getSourceObject().isEmpty()||this.map.fitBounds(t.getSourceObject(),{padding:15,animate:!1})},Voxel.Maps.Map.prototype.panTo=function(t){this.map.panTo(t.getSourceObject())},Voxel.Maps.Map.prototype.getClickPosition=function(t){return new Voxel.Maps.LatLng(t.lngLat.lat,t.lngLat.lng)},Voxel.Maps.Map.prototype.addListener=function(t,e){return this.map.on(this.mapEvent(t),function(t){e(t)}),{event:t,cb:e}},Voxel.Maps.Map.prototype.addListenerOnce=function(t,e){return this.map.once(this.mapEvent(t),function(t){e(t)}),{event:t,cb:e}},Voxel.Maps.Map.prototype.removeListener=function(t){this.map.off(t.event,t.cb)},Voxel.Maps.Map.prototype.trigger=function(t){this.map.fire(this.mapEvent(t))},Voxel.Maps.Map.prototype.getSourceObject=function(){return this.map},Voxel.Maps.Marker.prototype.init=function({map:t,position:e,onClick:o,data:s}){this.data=s,this.node=this.getTemplate().get(0),this.marker=new mapboxgl.Marker(this.node),this.onClick=o,this.node.addEventListener("click",t=>{o&&o(t,this)}),e&&this.setPosition(e),t&&this.setMap(t)},Voxel.Maps.Marker.prototype.getPosition=function(){return this.position},Voxel.Maps.Marker.prototype.setPosition=function(t){this.position=t,this.marker.setLngLat(t.getSourceObject())},Voxel.Maps.Marker.prototype.getMap=function(){return this.map},Voxel.Maps.Marker.prototype.setMap=function(t){this.map=t,this.marker.addTo(t.getSourceObject())},Voxel.Maps.Marker.prototype.remove=function(){return this.marker.remove(),this},Voxel.Maps.Marker.prototype.addClass=function(t){return this.node?.classList.add(t)},Voxel.Maps.Marker.prototype.removeClass=function(t){return this.node?.classList.remove(t)},Voxel.Maps.Marker.prototype.getSourceObject=function(){return this.marker},Voxel.Maps.Popup.prototype.init=function({map:t,position:e,content:o}){this.popup=new mapboxgl.Popup({closeButton:!1,maxWidth:"none",className:"ts-mapbox-popup ts-marker",anchor:"bottom",offset:0}),this.map=t,e&&this.setPosition(e),o&&this.setContent(o),t&&this.setMap(t)},Voxel.Maps.Popup.prototype.setContent=function(t){this.popup.setDOMContent(t)},Voxel.Maps.Popup.prototype.setPosition=function(t){this.popup.setLngLat(t.getSourceObject())},Voxel.Maps.Popup.prototype.setMap=function(t){this.map=t},Voxel.Maps.Popup.prototype.remove=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.show=function(){this.popup.addTo(this.map.getSourceObject()),setTimeout(()=>this.fitToScreen(),10)},Voxel.Maps.Popup.prototype.hide=function(){this.popup.remove()},Voxel.Maps.Popup.prototype.fitToScreen=function(){var t=this.popup.getElement(),e=t.getBoundingClientRect();let o=e.height+10,s=e.width/2+10,n=30,i=e.width/2+10;var e=this.map.getSourceObject(),r=e.getCanvas().getBoundingClientRect(),a=e.project(e.getCenter());let p=a.x,u=a.y;var l=e.project(this.popup.getLngLat());r.width-l.x<s&&(a.x+=s-(r.width-l.x)),l.x<i&&(a.x-=i-l.x),l.y<o-1&&(a.y-=o-l.y),r.height-l.y<n-1&&(a.y+=n-(r.height-l.y)),a.x===p&&a.y===u||e.panTo(e.unproject(a),{duration:t.querySelector(".ts-loading-popup")?0:200})},Voxel.Maps.Circle.prototype.init=function({map:t=null,center:e=null,radius:o=null}){this.map=t,this.locationNode=jQuery('<div class="hidden"><div class="map-circle-center"></div></div>').get(0),this.locationMarker=new mapboxgl.Marker(this.locationNode),this.locationMarker.setLngLat(e.getSourceObject()),this.locationMarker.addTo(t.getSourceObject()),this.node=jQuery('<div class="hidden"><div class="map-circle"></div></div>').get(0),this.marker=new mapboxgl.Marker(this.node),this.marker.setLngLat(e.getSourceObject()),this.radius=o,this.marker.addTo(t.getSourceObject()),this._draw(),t.addListener("zoom",()=>this._draw()),t.addListener("pitch",()=>this._draw())},Voxel.Maps.Circle.prototype.hide=function(){this.node.classList.add("hidden"),this.locationNode.classList.add("hidden")},Voxel.Maps.Circle.prototype.show=function(){this.node.classList.remove("hidden"),this.locationNode.classList.remove("hidden")},Voxel.Maps.Circle.prototype.setCenter=function(t){this.marker.setLngLat(t.getSourceObject()),this.locationMarker.setLngLat(t.getSourceObject()),this._draw()},Voxel.Maps.Circle.prototype.setRadius=function(t){this.radius=t,this._draw()},Voxel.Maps.Circle.prototype.getBounds=function(){return new Voxel.Maps.Bounds(new Voxel.Maps.LatLng(this.bounds.getSouth(),this.bounds.getWest()),new Voxel.Maps.LatLng(this.bounds.getNorth(),this.bounds.getEast()))},Voxel.Maps.Circle.prototype._updateBounds=function(){var t=this.marker.getLngLat(),e={north:null,east:null,south:null,west:null},o=(e.east=e.west=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng+1,t.lat)),e.north=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat+1)),e.south=this.radius/t.distanceTo(new mapboxgl.LngLat(t.lng,t.lat-1)),(t,e,o)=>Math.max(e,Math.min(t,o)));this.bounds=new mapboxgl.LngLatBounds([o(t.lng-e.west,-180,180),o(t.lat-e.south,-90,90)],[o(t.lng+e.east,-180,180),o(t.lat+e.north,-90,90)])},Voxel.Maps.Circle.prototype._draw=function(){this._updateBounds();var t=this.map.getSourceObject(),e=t.project(this.bounds.getSouthWest()),t=t.project(this.bounds.getNorthEast()),o=this.node.querySelector(".map-circle");o.style.left=e.x+"px",o.style.top=t.y+"px",o.style.width=t.x-e.x+"px",o.style.height=e.y-t.y+"px"};(function(t){t.exports=(()=>{let p=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class n{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");var[e,o]=new Uint8Array(t,0,2);if(219!==e)throw new Error("Data does not appear to be in a KDBush format.");e=o>>4;if(1!=e)throw new Error(`Got v${e} data when expected v1.`);var s,e=p[15&o];if(e)return[o]=new Uint16Array(t,2,1),[s]=new Uint32Array(t,4,1),new n(s,o,e,t);throw new Error("Unrecognized array type.")}constructor(t,e=64,o=Float64Array,s){if(isNaN(t)||t<=0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;var n=p.indexOf(this.ArrayType),i=2*t*this.ArrayType.BYTES_PER_ELEMENT,r=t*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-r%8)%8;if(n<0)throw new Error(`Unexpected typed array class: ${o}.`);s&&s instanceof ArrayBuffer?(this.data=s,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+r+a,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+i+r+a),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+r+a,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+n]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){var o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=e,o}finish(){var t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return function t(e,o,s,n,i,r){if(i-n<=s)return;let a=n+i>>1;d(e,o,a,n,i,r);t(e,o,s,n,a-1,1-r);t(e,o,s,1+a,i,1-r)}(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,o,s,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");for(var{ids:i,coords:r,nodeSize:t}=this,a=[0,i.length-1,0],p=[];a.length;){var u=a.pop()||0,l=a.pop()||0,h=a.pop()||0;if(l-h<=t)for(let t=h;t<=l;t++){var c=r[2*t],d=r[2*t+1];e<=c&&c<=s&&o<=d&&d<=n&&p.push(i[t])}else{var m=h+l>>1,g=r[2*m],f=r[2*m+1];e<=g&&g<=s&&o<=f&&f<=n&&p.push(i[m]),(0===u?e<=g:o<=f)&&(a.push(h),a.push(m-1),a.push(1-u)),(0===u?g<=s:f<=n)&&(a.push(1+m),a.push(l),a.push(1-u))}}return p}within(e,o,t){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");for(var{ids:s,coords:n,nodeSize:i}=this,r=[0,s.length-1,0],a=[],p=t*t;r.length;){var u=r.pop()||0,l=r.pop()||0,h=r.pop()||0;if(l-h<=i)for(let t=h;t<=l;t++)g(n[2*t],n[2*t+1],e,o)<=p&&a.push(s[t]);else{var c=h+l>>1,d=n[2*c],m=n[2*c+1];g(d,m,e,o)<=p&&a.push(s[c]),(0===u?e-t<=d:o-t<=m)&&(r.push(h),r.push(c-1),r.push(1-u)),(0===u?d<=e+t:m<=o+t)&&(r.push(1+c),r.push(l),r.push(1-u))}}return a}}function d(o,s,n,i,r,a){for(;i<r;){600<r-i&&(p=r-i+1,u=n-i+1,h=Math.log(p),l=.5*Math.exp(2*h/3),h=.5*Math.sqrt(h*l*(p-l)/p)*(u-p/2<0?-1:1),d(o,s,n,Math.max(i,Math.floor(n-u*l/p+h)),Math.min(r,Math.floor(n+(p-u)*l/p+h)),a));var p,u,l,h,c=s[2*n+a];let t=i,e=r;for(m(o,s,i,n),c<s[2*r+a]&&m(o,s,i,r);t<e;){for(m(o,s,t,e),t++,e--;s[2*t+a]<c;)t++;for(;s[2*e+a]>c;)e--}s[2*i+a]===c?m(o,s,i,e):m(o,s,++e,r),e<=n&&(i=e+1),n<=e&&(r=e-1)}}function m(t,e,o,s){i(t,o,s),i(e,2*o,2*s),i(e,2*o+1,2*s+1)}function i(t,e,o){var s=t[e];t[e]=t[o],t[o]=s}function g(t,e,o,s){t-=o,o=e-s;return t*t+o*o}let e={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:t=>t},l=Math.fround||(e=>t=>(e[0]=+t,e[0]))(new Float32Array(1)),f=3,b=5,r=6;class t{constructor(t){this.options=Object.assign(Object.create(e),t),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){var{log:o,minZoom:s,maxZoom:n}=this.options,t=(o&&console.time("total time"),`prepare ${e.length} points`),i=(o&&console.time(t),this.points=e,[]);for(let t=0;t<e.length;t++){var r,a=e[t];a.geometry&&([a,r]=a.geometry.coordinates,a=l(M(a)),r=l(y(r)),i.push(a,r,1/0,t,-1,1),this.options.reduce)&&i.push(0)}let p=this.trees[n+1]=this._createTree(i);o&&console.timeEnd(t);for(let t=n;t>=s;t--){var u=+Date.now();p=this.trees[t]=this._createTree(this._cluster(p,t)),o&&console.log("z%d: %d clusters in %dms",t,p.numItems,+Date.now()-u)}return o&&console.timeEnd("total time"),this}getClusters(t,e){let o=((t[0]+180)%360+360)%360-180;var s=Math.max(-90,Math.min(90,t[1]));let n=180===t[2]?180:((t[2]+180)%360+360)%360-180;var i=Math.max(-90,Math.min(90,t[3]));if(360<=t[2]-t[0])o=-180,n=180;else if(o>n)return t=this.getClusters([o,s,180,i],e),a=this.getClusters([-180,s,n,i],e),t.concat(a);var r,t=this.trees[this._limitZoom(e)],a=t.range(M(o),y(i),M(n),y(s)),p=t.data,u=[];for(r of a){var l=this.stride*r;u.push(1<p[l+b]?h(p,l,this.clusterProps):this.points[p[l+f]])}return u}getChildren(t){var e=this._getOriginId(t),o=this._getOriginZoom(t),s="No cluster with the specified id.",n=this.trees[o];if(!n)throw new Error(s);var i=n.data;if(e*this.stride>=i.length)throw new Error(s);var r,o=this.options.radius/(this.options.extent*Math.pow(2,o-1)),a=i[e*this.stride],e=i[e*this.stride+1],p=[];for(r of n.within(a,e,o)){var u=r*this.stride;i[4+u]===t&&p.push(1<i[u+b]?h(i,u,this.clusterProps):this.points[i[u+f]])}if(0===p.length)throw new Error(s);return p}getLeaves(t,e,o){var s=[];return this._appendLeaves(s,t,e=e||10,o=o||0,0),s}getTile(t,e,o){var s=this.trees[this._limitZoom(t)],t=Math.pow(2,t),{extent:n,radius:i}=this.options,i=i/n,n=(o-i)/t,r=(o+1+i)/t,a={features:[]};return this._addTileFeatures(s.range((e-i)/t,n,(e+1+i)/t,r),s.data,e,o,t,a),0===e&&this._addTileFeatures(s.range(1-i/t,n,1,r),s.data,t,o,t,a),e===t-1&&this._addTileFeatures(s.range(0,n,i/t,r),s.data,-1,o,t,a),a.features.length?a:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;for(;e<=this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e}_appendLeaves(t,e,o,s,n){var i;for(i of this.getChildren(e)){var r=i.properties;if(r&&r.cluster?n+r.point_count<=s?n+=r.point_count:n=this._appendLeaves(t,r.cluster_id,o,s,n):n<s?n++:t.push(i),t.length===o)break}return n}_createTree(e){var o=new n(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let t=0;t<e.length;t+=this.stride)o.add(e[t],e[t+1]);return o.finish(),o.data=e,o}_addTileFeatures(t,n,i,r,a,p){for(var u of t){var l,u=u*this.stride,h=1<n[u+b];let t,e,o;o=h?(t=x(n,u,this.clusterProps),e=n[u],n[1+u]):(c=this.points[n[u+f]],[c,l]=(t=c.properties,c.geometry.coordinates),e=M(c),y(l));var c={type:1,geometry:[[Math.round(this.options.extent*(e*a-i)),Math.round(this.options.extent*(o*a-r))]],tags:t};let s;void 0!==(s=h||this.options.generateId?n[u+f]:this.points[n[u+f]].id)&&(c.id=s),p.features.push(c)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,r){var{radius:e,extent:o,reduce:a,minPoints:s}=this.options,p=e/(o*Math.pow(2,r)),u=t.data,l=[],h=this.stride;for(let i=0;i<u.length;i+=h)if(!(u[i+2]<=r)){u[i+2]=r;var c,d=u[i],m=u[i+1],g=t.within(u[i],u[i+1],p),f=u[i+b];let n=f;for(c of g){var x=c*h;u[2+x]>r&&(n+=u[x+b])}if(n>f&&n>=s){let t=d*f,e=m*f,o,s=-1;var M,y=((i/h|0)<<5)+(r+1)+this.points.length;for(M of g){var V,v=M*h;u[2+v]<=r||(u[2+v]=r,V=u[v+b],t+=u[v]*V,e+=u[1+v]*V,u[4+v]=y,a&&(o||(o=this._map(u,i,!0),s=this.clusterProps.length,this.clusterProps.push(o)),a(o,this._map(u,v))))}u[i+4]=y,l.push(t/n,e/n,1/0,y,-1,n),a&&l.push(s)}else{for(let t=0;t<h;t++)l.push(u[i+t]);if(1<n)for(var w of g){var L=w*h;if(!(u[2+L]<=r)){u[2+L]=r;for(let t=0;t<h;t++)l.push(u[L+t])}}}}return l}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e,o){var s;return 1<t[e+b]?(s=this.clusterProps[t[e+r]],o?Object.assign({},s):s):(s=this.points[t[e+f]].properties,t=this.options.map(s),o&&t===s?Object.assign({},t):t)}}function h(t,e,o){return{type:"Feature",id:t[e+f],properties:x(t,e,o),geometry:{type:"Point",coordinates:[360*(t[e]-.5),(t=>(t=(180-360*t)*Math.PI/180,360*Math.atan(Math.exp(t))/Math.PI-90))(t[e+1])]}}}function x(t,e,o){var s=t[e+b],n=1e4<=s?Math.round(s/1e3)+"k":1e3<=s?Math.round(s/100)/10+"k":s,i=t[e+r],o=-1===i?{}:Object.assign({},o[i]);return Object.assign(o,{cluster:!0,cluster_id:t[e+f],point_count:s,point_count_abbreviated:n})}function M(t){return t/360+.5}function y(t){t=Math.sin(t*Math.PI/180),t=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return t<0?0:1<t?1:t}return t})()})(t={exports:{}});var t,e=t.exports;Voxel.Maps.Clusterer.prototype.init=function({map:t}){this.map=t,this.markers=[],this.clusters={},this.cluster=new e({radius:35,maxZoom:30}),this.map.addListener("zoomend",()=>this.render())},Voxel.Maps.Clusterer.prototype._getGeoJSON=function(){return this.markers.map(function(t,e){return{type:"Feature",geometry:{type:"Point",coordinates:[t.getPosition().getLongitude(),t.getPosition().getLatitude()]},properties:{sID:e+1,scID:0,marker:t}}})},Voxel.Maps.Clusterer.prototype.getSourceObject=function(){return this.cluster},Voxel.Maps.Clusterer.prototype.clearMarkers=function(){this.markers.map(t=>t.remove()),this.markers=[]},Voxel.Maps.Clusterer.prototype.addMarkers=function(t){this.markers.push(...t)},Voxel.Maps.Clusterer.prototype.render=function(){var t=this._getGeoJSON();t.length?(this.cluster.load(t),this.markers.map(t=>t.remove()),t=this.cluster.getClusters([-180,-90,180,90],Math.floor(this.map.getSourceObject().getZoom())),this._removeFeatures(),this._displayFeatures(t)):this._removeFeatures()},Voxel.Maps.Clusterer.prototype._displayFeatures=function(t){t.forEach(e=>{var t,o;e.properties.cluster?(t=`<div><div class="ts-marker-cluster">${e.properties.point_count_abbreviated}</div></div>`,t=jQuery(t).get(0),(o=new mapboxgl.Marker(t)).setLngLat(e.geometry.coordinates),o.addTo(this.map.getSourceObject()),this.clusters[e.properties.cluster_id]=o,t.addEventListener("click",t=>{t.preventDefault(),Math.round(this.map.getZoom())>=this.map.getMaxZoom()?(t=this.cluster.getLeaves(e.properties.cluster_id,-1).map(t=>t.properties.marker),"function"==typeof this._onNonExpandableClusterClick&&this._onNonExpandableClusterClick(t)):(this.map.getSourceObject().easeTo({center:e.geometry.coordinates,zoom:this.cluster.getClusterExpansionZoom(e.properties.cluster_id)}),"function"==typeof this._onClusterClick&&this._onClusterClick())})):e.properties.marker.setMap(this.map)})},Voxel.Maps.Clusterer.prototype._removeFeatures=function(){Object.values(this.clusters).map(t=>t.remove())},Voxel.Maps.Clusterer.prototype.onClusterClick=function(t){this._onClusterClick=t},Voxel.Maps.Clusterer.prototype.onNonExpandableClusterClick=function(t){this._onNonExpandableClusterClick=t},jQuery(t=>{var e=document.getElementById("mapbox-gl-js");e&&(e.src=e.dataset.src,e.addEventListener("load",()=>{mapboxgl.accessToken=Voxel_Config.mapbox?.api_key,Voxel_Config.mapbox.language||(Voxel_Config.mapbox.language="auto"),Voxel.Maps.Loaded=!0,document.dispatchEvent(new Event("maps:loaded")),jQuery(document).on("voxel:markup-update",()=>{requestAnimationFrame(()=>jQuery(document).trigger("maps:loaded"))})},{once:!0}))}),jQuery(document).on("maps:loaded",()=>{jQuery(".ts-map.ts-map-autoload").each((t,o)=>{if(!o.__map_loaded__){o.__map_loaded__=!0;var s=jQuery(o).data("config"),o={el:o,zoom:3};s&&(s.zoom&&(o.zoom=s.zoom),s.minZoom&&(o.minZoom=s.minZoom),s.maxZoom&&(o.maxZoom=s.maxZoom),s.center)&&(o.center=new Voxel.Maps.LatLng(s.center.lat,s.center.lng));let e=new Voxel.Maps.Map(o);s.markers&&s.markers.forEach(t=>{new Voxel.Maps.Marker({map:e,position:new Voxel.Maps.LatLng(t.lat,t.lng),template:t.uriencoded?decodeURIComponent(t.template):t.template})})}})})});
